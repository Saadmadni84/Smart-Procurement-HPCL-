# GitLab CI/CD Pipeline
# HPCL Procurement Automation System
# Version: 1.0

stages:
  - build
  - test
  - security-scan
  - build-image
  - deploy-staging
  - integration-tests
  - deploy-prod

variables:
  MAVEN_OPTS: "-Dmaven.repo.local=.m2/repository"
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  HARBOR_REGISTRY: "harbor.hpcl.com"
  IMAGE_NAME: "$HARBOR_REGISTRY/procurement/procurement-api"
  K8S_NAMESPACE_STAGING: "hpcl-procurement-staging"
  K8S_NAMESPACE_PROD: "hpcl-procurement"

cache:
  paths:
    - .m2/repository
    - node_modules/

# ============================================
# STAGE 1: BUILD
# ============================================

build-backend:
  stage: build
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Building Spring Boot application..."
    - cd backend
    - mvn clean compile -DskipTests
    - mvn package -DskipTests
  artifacts:
    paths:
      - backend/target/*.jar
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests
  tags:
    - docker

build-frontend:
  stage: build
  image: node:18-alpine
  script:
    - echo "Building React frontend..."
    - cd frontend
    - npm ci
    - npm run build
  artifacts:
    paths:
      - frontend/dist/
    expire_in: 1 hour
  only:
    - main
    - develop
    - merge_requests
  tags:
    - docker

# ============================================
# STAGE 2: TEST
# ============================================

unit-tests:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Running unit tests..."
    - cd backend
    - mvn test
  coverage: '/Total.*?([0-9]{1,3})%/'
  artifacts:
    when: always
    reports:
      junit:
        - backend/target/surefire-reports/TEST-*.xml
      coverage_report:
        coverage_format: cobertura
        path: backend/target/site/cobertura/coverage.xml
  only:
    - main
    - develop
    - merge_requests
  tags:
    - docker

integration-tests-backend:
  stage: test
  image: maven:3.9-eclipse-temurin-17
  services:
    - name: mysql:8.0
      alias: mysql
  variables:
    MYSQL_ROOT_PASSWORD: "test_password"
    MYSQL_DATABASE: "hpcl_procurement_test"
    SPRING_DATASOURCE_URL: "jdbc:mysql://mysql:3306/hpcl_procurement_test"
    SPRING_DATASOURCE_USERNAME: "root"
    SPRING_DATASOURCE_PASSWORD: "test_password"
  script:
    - echo "Running integration tests..."
    - cd backend
    - mvn verify -Pintegration-test
  artifacts:
    when: always
    reports:
      junit:
        - backend/target/failsafe-reports/TEST-*.xml
  only:
    - main
    - develop
  tags:
    - docker

frontend-tests:
  stage: test
  image: node:18-alpine
  script:
    - echo "Running frontend tests..."
    - cd frontend
    - npm ci
    - npm run test -- --coverage
  coverage: '/All files[^|]*\|[^|]*\s+([\d\.]+)/'
  artifacts:
    when: always
    reports:
      coverage_report:
        coverage_format: cobertura
        path: frontend/coverage/cobertura-coverage.xml
  only:
    - main
    - develop
    - merge_requests
  tags:
    - docker

# ============================================
# STAGE 3: SECURITY SCAN
# ============================================

sonarqube-scan:
  stage: security-scan
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Running SonarQube analysis..."
    - cd backend
    - mvn sonar:sonar 
        -Dsonar.projectKey=hpcl-procurement 
        -Dsonar.host.url=$SONAR_HOST_URL 
        -Dsonar.login=$SONAR_TOKEN
  only:
    - main
    - develop
  tags:
    - docker
  allow_failure: true

dependency-check:
  stage: security-scan
  image: maven:3.9-eclipse-temurin-17
  script:
    - echo "Checking for vulnerable dependencies..."
    - cd backend
    - mvn org.owasp:dependency-check-maven:check
  artifacts:
    when: always
    paths:
      - backend/target/dependency-check-report.html
    expire_in: 7 days
  only:
    - main
    - develop
  tags:
    - docker
  allow_failure: true

trivy-scan:
  stage: security-scan
  image: aquasec/trivy:latest
  script:
    - echo "Scanning for security vulnerabilities with Trivy..."
    - trivy fs --exit-code 0 --severity HIGH,CRITICAL backend/
  only:
    - main
    - develop
  tags:
    - docker
  allow_failure: true

# ============================================
# STAGE 4: BUILD DOCKER IMAGE
# ============================================

build-docker-backend:
  stage: build-image
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $HARBOR_USERNAME -p $HARBOR_PASSWORD $HARBOR_REGISTRY
  script:
    - echo "Building backend Docker image..."
    - cd backend
    - |
      docker build \
        --build-arg JAR_FILE=target/*.jar \
        --tag $IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
        --tag $IMAGE_NAME:latest \
        .
    - docker push $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
    - docker push $IMAGE_NAME:latest
  only:
    - main
    - develop
  tags:
    - docker

build-docker-frontend:
  stage: build-image
  image: docker:24-dind
  services:
    - docker:24-dind
  before_script:
    - docker login -u $HARBOR_USERNAME -p $HARBOR_PASSWORD $HARBOR_REGISTRY
  script:
    - echo "Building frontend Docker image..."
    - cd frontend
    - |
      docker build \
        --tag $HARBOR_REGISTRY/procurement/procurement-frontend:$CI_COMMIT_SHORT_SHA \
        --tag $HARBOR_REGISTRY/procurement/procurement-frontend:latest \
        .
    - docker push $HARBOR_REGISTRY/procurement/procurement-frontend:$CI_COMMIT_SHORT_SHA
    - docker push $HARBOR_REGISTRY/procurement/procurement-frontend:latest
  only:
    - main
    - develop
  tags:
    - docker

trivy-image-scan:
  stage: build-image
  image: aquasec/trivy:latest
  script:
    - echo "Scanning Docker image for vulnerabilities..."
    - trivy image --exit-code 0 --severity HIGH,CRITICAL $IMAGE_NAME:$CI_COMMIT_SHORT_SHA
  dependencies:
    - build-docker-backend
  only:
    - main
    - develop
  tags:
    - docker
  allow_failure: true

# ============================================
# STAGE 5: DEPLOY TO STAGING
# ============================================

deploy-staging:
  stage: deploy-staging
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_STAGING" | base64 -d > ~/.kube/config
  script:
    - echo "Deploying to staging environment..."
    - kubectl config use-context staging-cluster
    - |
      kubectl set image deployment/procurement-api \
        procurement-api=$IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
        -n $K8S_NAMESPACE_STAGING
    - |
      kubectl set image deployment/procurement-frontend \
        nginx=$HARBOR_REGISTRY/procurement/procurement-frontend:$CI_COMMIT_SHORT_SHA \
        -n $K8S_NAMESPACE_STAGING
    - kubectl rollout status deployment/procurement-api -n $K8S_NAMESPACE_STAGING --timeout=5m
    - kubectl rollout status deployment/procurement-frontend -n $K8S_NAMESPACE_STAGING --timeout=5m
    - echo "Deployment to staging completed successfully"
  environment:
    name: staging
    url: https://staging-procurement.hpcl.com
  only:
    - develop
  tags:
    - docker

db-migration-staging:
  stage: deploy-staging
  image: flyway/flyway:9
  script:
    - echo "Running database migrations on staging..."
    - |
      flyway migrate \
        -url=$STAGING_DB_URL \
        -user=$STAGING_DB_USER \
        -password=$STAGING_DB_PASSWORD \
        -locations=filesystem:./database/migrations
  only:
    - develop
  tags:
    - docker

# ============================================
# STAGE 6: INTEGRATION TESTS (POST-DEPLOY)
# ============================================

smoke-tests-staging:
  stage: integration-tests
  image: curlimages/curl:latest
  script:
    - echo "Running smoke tests on staging..."
    - |
      # Health check
      curl -f https://staging-api.hpcl-procurement.example.com/actuator/health || exit 1
    - |
      # API test - Create PR
      curl -f -X POST https://staging-api.hpcl-procurement.example.com/api/v1/pr \
        -H "Authorization: Bearer $STAGING_JWT_TOKEN" \
        -H "Content-Type: application/json" \
        -d '{"description":"Test PR","category":"CHEMICALS","estimated_budget":100000,"required_date":"2025-12-31","department":"IT","items":[{"description":"Test item","quantity":1,"unit":"PC"}]}' \
        || exit 1
    - echo "Smoke tests passed"
  dependencies:
    - deploy-staging
  only:
    - develop
  tags:
    - docker

api-tests-staging:
  stage: integration-tests
  image: postman/newman:latest
  script:
    - echo "Running API tests with Newman..."
    - newman run tests/postman/procurement-api.postman_collection.json \
        --environment tests/postman/staging.postman_environment.json \
        --reporters cli,junit \
        --reporter-junit-export newman-results.xml
  artifacts:
    when: always
    reports:
      junit: newman-results.xml
  dependencies:
    - deploy-staging
  only:
    - develop
  tags:
    - docker

# ============================================
# STAGE 7: DEPLOY TO PRODUCTION
# ============================================

deploy-production:
  stage: deploy-prod
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_PROD" | base64 -d > ~/.kube/config
  script:
    - echo "Deploying to production environment..."
    - kubectl config use-context prod-cluster
    - |
      kubectl set image deployment/procurement-api \
        procurement-api=$IMAGE_NAME:$CI_COMMIT_SHORT_SHA \
        -n $K8S_NAMESPACE_PROD
    - |
      kubectl set image deployment/procurement-frontend \
        nginx=$HARBOR_REGISTRY/procurement/procurement-frontend:$CI_COMMIT_SHORT_SHA \
        -n $K8S_NAMESPACE_PROD
    - kubectl rollout status deployment/procurement-api -n $K8S_NAMESPACE_PROD --timeout=10m
    - kubectl rollout status deployment/procurement-frontend -n $K8S_NAMESPACE_PROD --timeout=10m
    - echo "Production deployment completed"
  environment:
    name: production
    url: https://procurement.hpcl.com
  when: manual
  only:
    - main
  tags:
    - docker

db-migration-production:
  stage: deploy-prod
  image: flyway/flyway:9
  script:
    - echo "Running database migrations on production..."
    - |
      flyway migrate \
        -url=$PROD_DB_URL \
        -user=$PROD_DB_USER \
        -password=$PROD_DB_PASSWORD \
        -locations=filesystem:./database/migrations
  when: manual
  only:
    - main
  tags:
    - docker

smoke-tests-production:
  stage: deploy-prod
  image: curlimages/curl:latest
  script:
    - echo "Running smoke tests on production..."
    - |
      # Health check
      curl -f https://api.hpcl-procurement.example.com/actuator/health || exit 1
    - echo "Production smoke tests passed"
  dependencies:
    - deploy-production
  only:
    - main
  tags:
    - docker

# ============================================
# NOTIFICATION (ON FAILURE)
# ============================================

notify-failure:
  stage: .post
  image: alpine:latest
  before_script:
    - apk add --no-cache curl
  script:
    - |
      curl -X POST $SLACK_WEBHOOK_URL \
        -H 'Content-Type: application/json' \
        -d "{\"text\":\"âŒ Pipeline failed for $CI_PROJECT_NAME on branch $CI_COMMIT_REF_NAME. Job: $CI_JOB_NAME. See: $CI_PIPELINE_URL\"}"
  when: on_failure
  only:
    - main
    - develop
  tags:
    - docker

# ============================================
# ROLLBACK (MANUAL TRIGGER)
# ============================================

rollback-production:
  stage: deploy-prod
  image: bitnami/kubectl:latest
  before_script:
    - mkdir -p ~/.kube
    - echo "$KUBECONFIG_PROD" | base64 -d > ~/.kube/config
  script:
    - echo "Rolling back production deployment..."
    - kubectl rollout undo deployment/procurement-api -n $K8S_NAMESPACE_PROD
    - kubectl rollout undo deployment/procurement-frontend -n $K8S_NAMESPACE_PROD
    - echo "Rollback completed"
  when: manual
  only:
    - main
  tags:
    - docker
