openapi: 3.0.3
info:
  title: HPCL Procurement API - Purchase Request Management
  description: |
    API for managing Purchase Requests (PRs), approvals, business rules, exceptions, and reporting.
    
    **Authentication**: Bearer JWT token (RS256)
    
    **Base URL**: https://api.hpcl-procurement.example.com/api/v1
    
    **Rate Limiting**: 1000 requests/minute per user
  version: 1.0.0
  contact:
    name: HPCL API Support
    email: api-support@hpcl.com
  license:
    name: Proprietary
    url: https://hpcl.com/licenses

servers:
  - url: https://api.hpcl-procurement.example.com/api/v1
    description: Production
  - url: https://staging-api.hpcl-procurement.example.com/api/v1
    description: Staging
  - url: http://localhost:8080/api/v1
    description: Local Development

security:
  - bearerAuth: []

tags:
  - name: Purchase Requests
    description: Create, read, update PRs
  - name: Approvals
    description: Approve/reject PRs
  - name: Business Rules
    description: Manage approval rules
  - name: Exceptions
    description: Handle PR exceptions
  - name: Reports
    description: Analytics and reporting

paths:
  /pr:
    post:
      tags:
        - Purchase Requests
      summary: Create Purchase Request
      description: |
        Create a new Purchase Request. Triggers:
        - Business rule evaluation
        - Workflow initiation
        - Notification to approvers
      operationId: createPR
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PRCreateRequest'
            examples:
              chemicals:
                summary: Chemical procurement
                value:
                  description: Supply of Caustic Soda
                  detailed_description: Procurement of 500 MT of Caustic Soda, 98% purity
                  category: CHEMICALS
                  estimated_budget: 2500000.00
                  required_date: "2025-12-15"
                  justification: Required for refinery operations
                  department: REFINERY_OPS
                  priority: HIGH
                  items:
                    - material_code: "CHEM-CS-001"
                      description: Caustic Soda 98%
                      quantity: 500
                      unit: MT
                      estimated_unit_price: 5000.00
                      specification: "Purity >= 98%, HDPE drums"
                      delivery_location: "Mumbai Refinery"
      responses:
        '201':
          description: PR created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PRResponse'
              example:
                id: 1
                pr_number: "PR-2025-001"
                status: PENDING_APPROVAL_L1
                created_by: requestor@hpcl.com
                created_at: "2025-11-21T14:30:00+05:30"
                workflow_instance_id: "wf-12345"
                approvers:
                  - level: 1
                    approver_email: approver.l1@hpcl.com
                    status: PENDING
                  - level: 2
                    approver_email: approver.l2@hpcl.com
                    status: PENDING
        '400':
          $ref: '#/components/responses/ValidationError'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '500':
          $ref: '#/components/responses/InternalServerError'

    get:
      tags:
        - Purchase Requests
      summary: List Purchase Requests
      description: Retrieve PRs with filters and pagination
      operationId: listPRs
      parameters:
        - name: status
          in: query
          description: Filter by PR status
          schema:
            type: string
            enum: [DRAFT, PENDING_APPROVAL_L1, PENDING_APPROVAL_L2, APPROVED, REJECTED, EXCEPTION, PO_CREATED]
        - name: department
          in: query
          description: Filter by department
          schema:
            type: string
        - name: from_date
          in: query
          description: Filter by creation date (start)
          schema:
            type: string
            format: date
        - name: to_date
          in: query
          description: Filter by creation date (end)
          schema:
            type: string
            format: date
        - name: page
          in: query
          description: Page number (0-indexed)
          schema:
            type: integer
            default: 0
        - name: size
          in: query
          description: Page size
          schema:
            type: integer
            default: 20
            maximum: 100
        - name: sort
          in: query
          description: Sort field and direction
          schema:
            type: string
            example: "created_at,desc"
      responses:
        '200':
          description: List of PRs
          content:
            application/json:
              schema:
                type: object
                properties:
                  content:
                    type: array
                    items:
                      $ref: '#/components/schemas/PRSummary'
                  page:
                    type: integer
                  size:
                    type: integer
                  total_elements:
                    type: integer
                  total_pages:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'

  /pr/{id}:
    get:
      tags:
        - Purchase Requests
      summary: Get PR by ID
      description: Retrieve detailed PR information
      operationId: getPRById
      parameters:
        - name: id
          in: path
          required: true
          description: PR ID
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: PR details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PRResponse'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    put:
      tags:
        - Purchase Requests
      summary: Update PR
      description: Update PR (only allowed in DRAFT status)
      operationId: updatePR
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PRUpdateRequest'
      responses:
        '200':
          description: PR updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PRResponse'
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflict - PR not in DRAFT status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    delete:
      tags:
        - Purchase Requests
      summary: Delete PR
      description: Soft delete PR (only allowed in DRAFT status)
      operationId: deletePR
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '204':
          description: PR deleted successfully
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Conflict - PR not in DRAFT status

  /pr/{id}/approve:
    post:
      tags:
        - Approvals
      summary: Approve Purchase Request
      description: |
        Approve PR at current approval level.
        Triggers:
        - Digital signature (DSC)
        - Workflow progression
        - Notification to next approver (if applicable)
      operationId: approvePR
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ApprovalRequest'
            example:
              comments: "Approved as per budget allocation"
              digital_signature:
                certificate_serial: "DSC-HPCL-APPROVER-001"
                signature_data: "MIIGhgYJKoZIhvcNAQcCoIIG..."
      responses:
        '200':
          description: PR approved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ApprovalResponse'
              example:
                approval_id: 101
                pr_id: 1
                approver_level: 1
                status: APPROVED
                approved_at: "2025-11-21T15:00:00+05:30"
                next_approver: "approver.l2@hpcl.com"
        '400':
          $ref: '#/components/responses/ValidationError'
        '404':
          $ref: '#/components/responses/NotFound'
        '403':
          description: Forbidden - User not authorized to approve
        '409':
          description: Conflict - PR already approved at this level

  /pr/{id}/reject:
    post:
      tags:
        - Approvals
      summary: Reject Purchase Request
      description: Reject PR with mandatory comments
      operationId: rejectPR
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - rejection_reason
                - comments
              properties:
                rejection_reason:
                  type: string
                  enum: [BUDGET_EXCEEDED, INVALID_JUSTIFICATION, DUPLICATE_REQUEST, OTHER]
                comments:
                  type: string
                  minLength: 10
            example:
              rejection_reason: BUDGET_EXCEEDED
              comments: "Budget allocation exhausted for this quarter"
      responses:
        '200':
          description: PR rejected successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  pr_id:
                    type: integer
                  status:
                    type: string
                    example: REJECTED
                  rejected_at:
                    type: string
                    format: date-time
        '404':
          $ref: '#/components/responses/NotFound'

  /pr/{id}/attachments:
    post:
      tags:
        - Purchase Requests
      summary: Upload Attachment
      description: Upload document (PDF, Excel, images) to PR
      operationId: uploadAttachment
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              required:
                - file
                - document_type
              properties:
                file:
                  type: string
                  format: binary
                document_type:
                  type: string
                  enum: [REQUISITION, TECHNICAL_SPEC, QUOTATION, OTHER]
      responses:
        '201':
          description: Attachment uploaded successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AttachmentResponse'
        '400':
          description: Invalid file type or size
        '413':
          description: File too large (max 10MB)

    get:
      tags:
        - Purchase Requests
      summary: List Attachments
      description: Get all attachments for a PR
      operationId: listAttachments
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: List of attachments
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/AttachmentResponse'

  /pr/{id}/exceptions:
    get:
      tags:
        - Exceptions
      summary: Get PR Exceptions
      description: Retrieve all exceptions for a PR
      operationId: getPRExceptions
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      responses:
        '200':
          description: List of exceptions
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ExceptionResponse'

  /exceptions/{id}/resolve:
    post:
      tags:
        - Exceptions
      summary: Resolve Exception
      description: Mark exception as resolved with resolution notes
      operationId: resolveException
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
            format: int64
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required:
                - resolution_notes
              properties:
                resolution_notes:
                  type: string
                  minLength: 20
            example:
              resolution_notes: "SAP PO created manually, SAP adapter issue resolved"
      responses:
        '200':
          description: Exception resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExceptionResponse'

  /rules:
    get:
      tags:
        - Business Rules
      summary: List Business Rules
      description: Get all active business rules
      operationId: listRules
      responses:
        '200':
          description: List of rules
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BusinessRuleResponse'

    post:
      tags:
        - Business Rules
      summary: Create Business Rule
      description: Create new approval rule (admin only)
      operationId: createRule
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BusinessRuleRequest'
      responses:
        '201':
          description: Rule created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BusinessRuleResponse'
        '403':
          description: Forbidden - Admin access required

  /reports/pr-summary:
    get:
      tags:
        - Reports
      summary: PR Summary Report
      description: Get PR summary by status, department, date range
      operationId: getPRSummary
      parameters:
        - name: from_date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: to_date
          in: query
          required: true
          schema:
            type: string
            format: date
        - name: department
          in: query
          schema:
            type: string
      responses:
        '200':
          description: PR summary
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PRSummaryReport'

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token obtained from Keycloak.
        Include in Authorization header: `Bearer <token>`

  schemas:
    PRCreateRequest:
      type: object
      required:
        - description
        - category
        - estimated_budget
        - required_date
        - department
        - items
      properties:
        description:
          type: string
          maxLength: 200
          example: "Supply of Industrial Chemicals"
        detailed_description:
          type: string
          maxLength: 2000
        category:
          type: string
          enum: [CHEMICALS, STATIONERY, IT_HARDWARE, MACHINERY, SERVICES, OTHER]
        estimated_budget:
          type: number
          format: double
          minimum: 0
          example: 2500000.00
        required_date:
          type: string
          format: date
          example: "2025-12-15"
        justification:
          type: string
          maxLength: 500
        department:
          type: string
          example: "REFINERY_OPS"
        priority:
          type: string
          enum: [LOW, MEDIUM, HIGH, CRITICAL]
          default: MEDIUM
        items:
          type: array
          minItems: 1
          items:
            $ref: '#/components/schemas/PRItemRequest'

    PRItemRequest:
      type: object
      required:
        - description
        - quantity
        - unit
      properties:
        material_code:
          type: string
          example: "CHEM-CS-001"
        description:
          type: string
          maxLength: 500
        quantity:
          type: number
          format: double
          minimum: 0
        unit:
          type: string
          example: "MT"
        estimated_unit_price:
          type: number
          format: double
        specification:
          type: string
          maxLength: 1000
        delivery_location:
          type: string

    PRUpdateRequest:
      type: object
      properties:
        description:
          type: string
        detailed_description:
          type: string
        estimated_budget:
          type: number
        required_date:
          type: string
          format: date
        justification:
          type: string
        priority:
          type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/PRItemRequest'

    PRResponse:
      type: object
      properties:
        id:
          type: integer
          format: int64
        pr_number:
          type: string
        description:
          type: string
        category:
          type: string
        estimated_budget:
          type: number
        status:
          type: string
        created_by:
          type: string
        created_at:
          type: string
          format: date-time
        workflow_instance_id:
          type: string
        approvers:
          type: array
          items:
            type: object
            properties:
              level:
                type: integer
              approver_email:
                type: string
              status:
                type: string
        items:
          type: array
          items:
            $ref: '#/components/schemas/PRItemResponse'

    PRSummary:
      type: object
      properties:
        id:
          type: integer
        pr_number:
          type: string
        description:
          type: string
        estimated_budget:
          type: number
        status:
          type: string
        created_at:
          type: string
          format: date-time

    PRItemResponse:
      type: object
      properties:
        id:
          type: integer
        material_code:
          type: string
        description:
          type: string
        quantity:
          type: number
        unit:
          type: string
        estimated_unit_price:
          type: number

    ApprovalRequest:
      type: object
      required:
        - digital_signature
      properties:
        comments:
          type: string
          maxLength: 500
        digital_signature:
          type: object
          required:
            - certificate_serial
            - signature_data
          properties:
            certificate_serial:
              type: string
            signature_data:
              type: string
              description: Base64-encoded PKCS#7 signature

    ApprovalResponse:
      type: object
      properties:
        approval_id:
          type: integer
        pr_id:
          type: integer
        approver_level:
          type: integer
        status:
          type: string
        approved_at:
          type: string
          format: date-time
        next_approver:
          type: string

    AttachmentResponse:
      type: object
      properties:
        id:
          type: integer
        file_name:
          type: string
        file_size:
          type: integer
        document_type:
          type: string
        uploaded_at:
          type: string
          format: date-time
        download_url:
          type: string
          description: Pre-signed URL (1 hour expiry)

    ExceptionResponse:
      type: object
      properties:
        id:
          type: integer
        pr_id:
          type: integer
        exception_type:
          type: string
          enum: [SAP_SYNC_FAILED, RULE_VIOLATION, WORKFLOW_ERROR, OTHER]
        error_message:
          type: string
        status:
          type: string
          enum: [OPEN, IN_PROGRESS, RESOLVED]
        created_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time

    BusinessRuleRequest:
      type: object
      required:
        - rule_name
        - condition
        - action
      properties:
        rule_name:
          type: string
        condition:
          type: string
          description: Drools rule condition
        action:
          type: string
          description: Action to execute

    BusinessRuleResponse:
      type: object
      properties:
        id:
          type: integer
        rule_name:
          type: string
        condition:
          type: string
        action:
          type: string
        is_active:
          type: boolean
        created_at:
          type: string
          format: date-time

    PRSummaryReport:
      type: object
      properties:
        total_prs:
          type: integer
        by_status:
          type: object
          additionalProperties:
            type: integer
        by_department:
          type: object
          additionalProperties:
            type: integer
        total_value:
          type: number

    Error:
      type: object
      properties:
        error_code:
          type: string
        message:
          type: string
        timestamp:
          type: string
          format: date-time
        path:
          type: string

  responses:
    ValidationError:
      description: Validation error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error_code: VALIDATION_ERROR
            message: "estimated_budget must be greater than 0"
            timestamp: "2025-11-21T14:30:00+05:30"
            path: "/api/v1/pr"

    Unauthorized:
      description: Unauthorized - Invalid or missing JWT token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error_code: UNAUTHORIZED
            message: "JWT token missing or invalid"

    Forbidden:
      description: Forbidden - Insufficient permissions
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error_code: NOT_FOUND
            message: "PR with ID 999 not found"

    InternalServerError:
      description: Internal server error
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
          example:
            error_code: INTERNAL_SERVER_ERROR
            message: "An unexpected error occurred"
